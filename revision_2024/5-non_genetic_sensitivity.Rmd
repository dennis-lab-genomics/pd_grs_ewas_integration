---
title: "TERRE GRS: Non-genetic factors sensitivity analysis"
output: html_notebook
---

The manuscript "A Parkinson’s disease genetic risk score associates with blood DNAm on chromosome 17" explores how a genetic risk score (GRS) for Parkinson's disease (PD) associates with blood DNA methylation in the TERRE study of French agricultural workers, and evaluates GRS associations with DNAm in each sex as well as their sensitivity to non-genetic factors. This was originally spearheaded by Will Casazza and was posted as a pre-print on medRxiv in 2023. The current revision (2024, led by Sam Schaffner) aims to address previous reviewer feedback and prepare the manuscript for re-submission.

Here, EWAS for the GRS will be repeated with adjustment for the following non-genetic factors: **smoking status, alcohol use, age, sex, self-reported previous head injury, and individual occupational pesticide and heavy metal exposures** surveyed in TERRE. Will initially examined all 69 available exposures. I'll subset to the ones with at least 10 "exposed" individuals to generate a more reliable estimate of exposure effect (as done for npj PD paper).


Last updated Aug 7, 2024 by Samantha Schaffner


Based on code by Will Casazza

```{r setup, include=FALSE, eval=F}
library(lumi)
library(limma)
library(minfi)
library(rcompanion)
library(readxl)
library(tidyverse)
library(ggpubr)
library(glue)
library(data.table)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(UpSetR)
library(mice)
source("~/kobor_shared_coding_resource/qqplot_NG.R")
knitr::opts_chunk$set(echo = TRUE)
```


### Loading in and preparing data
```{r load dat, eval=FALSE}
meta <- read.csv("~/PD_GRS/meta_geno_DNAm_PCs.csv")

# DNAm data (2022, most recent QC'ed, same as npj PD 2024 article)
load("~/SHARE_DECIPHER/processed_DNAm_data/2022/TERRE_processed_2022/1-TERRE_RG_filtered.RData")
mvals <- getM(PD_RG_filtered)
rm(PD_RG_filtered)

## Preparing data
# match meta data and M-values
meta <- meta[complete.cases(meta$CTP_PC1),]
mvals <- mvals[,match(meta$patient, colnames(mvals))]
all(colnames(mvals)==meta$patient) #TRUE

# subset meta data to relevant columns and re-format
meta_sub <- meta[,c("patient","SCORE1_AVG","PD","age","sex","geno_V3","geno_V4","geno_V5","CTP_PC1","CTP_PC2","CTP_PC3","CTP_PC4","CTP_PC5","CTP_PC6","smoking","pesticides","head_trauma","alcohol1","levodopa","agonist","plate","SentrixPosition_A")]
str(meta_sub)
meta_sub$PD <- as.factor(meta_sub$PD)
meta_sub$sex <- as.factor(meta_sub$sex)
meta_sub$smoking <- as.factor(meta_sub$smoking)
meta_sub$pesticides <- as.factor(meta_sub$pesticides)
meta_sub$head_trauma <- as.factor(meta_sub$head_trauma)
meta_sub$alcohol1 <- as.factor(meta_sub$alcohol1)
meta_sub$levodopa <- as.factor(meta_sub$levodopa)
meta_sub$plate <- as.factor(meta_sub$plate)
meta_sub$SentrixPosition_A <- as.factor(meta_sub$SentrixPosition_A)
```

# Association analyses

Will used limma on all EPIC probes passing QC, modeling the data with M-values. I'll continue with this approach and transform results back to beta values later for plotting and interpretation purposes.

## Smoking, alcohol, head trauma, and overall pesticide exposure

```{r prs ewas, eval=F}
# check meta data for missing values
summary(meta_sub) #20 missing pesticides, otherwise complete

# adjustment for smoking
design_smoke <- model.matrix(~ 1 + SCORE1_AVG + age + sex + geno_V3 + geno_V4 + geno_V5 + CTP_PC1 + CTP_PC2 + CTP_PC3 + CTP_PC4 + CTP_PC5 + CTP_PC6 + plate + SentrixPosition_A + PD + smoking, data = meta_sub)
smoke_fit <- lmFit(mvals, design_smoke)
smoke_fit <- eBayes(smoke_fit)
smoke_res <- limma::topTable(smoke_fit, coef = 2, number = Inf, genelist=rownames(mvals))
write.csv(smoke_res, file="~/PD_GRS/non_genetic_sensitivity/EWAS_GRS_smoke.csv", row.names=F)

# adjustment for head trauma
design_ht <- model.matrix(~ 1 + SCORE1_AVG + age + sex + geno_V3 + geno_V4 + geno_V5 + CTP_PC1 + CTP_PC2 + CTP_PC3 + CTP_PC4 + CTP_PC5 + CTP_PC6 + plate + SentrixPosition_A + PD + head_trauma, data = meta_sub)
ht_fit <- lmFit(mvals, design_ht)
ht_fit <- eBayes(ht_fit)
ht_res <- limma::topTable(ht_fit, coef = 2, number = Inf, genelist=rownames(mvals))
write.csv(ht_res, file="~/PD_GRS/non_genetic_sensitivity/EWAS_GRS_ht.csv", row.names=F)

# adjustment for alcohol
design_alc <- model.matrix(~ 1 + SCORE1_AVG + age + sex + geno_V3 + geno_V4 + geno_V5 + CTP_PC1 + CTP_PC2 + CTP_PC3 + CTP_PC4 + CTP_PC5 + CTP_PC6 + plate + SentrixPosition_A + PD + alcohol1, data = meta_sub)
alc_fit <- lmFit(mvals, design_alc)
alc_fit <- eBayes(alc_fit)
alc_res <- limma::topTable(alc_fit, coef = 2, number = Inf, genelist=rownames(mvals))
write.csv(alc_res, file="~/PD_GRS/non_genetic_sensitivity/EWAS_GRS_alc.csv", row.names=F)

# adjustment for overall pesticide exposure
meta_pest <- meta_sub[complete.cases(meta_sub$pesticides),]
summary(meta_pest$PD)
#  0   1 
#135  63 
mvals_pest <- mvals[,match(meta_pest$patient, colnames(mvals))]
design_pest <- model.matrix(~ 1 + SCORE1_AVG + age + sex + geno_V3 + geno_V4 + geno_V5 + CTP_PC1 + CTP_PC2 + CTP_PC3 + CTP_PC4 + CTP_PC5 + CTP_PC6 + plate + SentrixPosition_A + PD + pesticides, data = meta_pest)
pest_fit <- lmFit(mvals_pest, design_pest)
pest_fit <- eBayes(pest_fit)
pest_res <- limma::topTable(pest_fit, coef = 2, number = Inf, genelist=rownames(mvals))
write.csv(pest_res, file="~/PD_GRS/non_genetic_sensitivity/EWAS_GRS_pest.csv", row.names=F)
```

### Compare results with initial GRS EWAS
```{r compare, eval=F}
grs_res <- read.csv("~/PD_GRS/EWAS_TERRE/EWAS_GRS_cross_sex_hits.csv")

nrow(smoke_hits <- smoke_res[abs(smoke_res$logFC)>=1.5 & smoke_res$adj.P.Val<=0.05,]) #24
nrow(ht_hits <- ht_res[abs(ht_res$logFC)>=1.5 & ht_res$adj.P.Val<=0.05,]) #24
nrow(alc_hits <- alc_res[abs(alc_res$logFC)>=1.5 & alc_res$adj.P.Val<=0.05,]) #26
nrow(pest_hits <- pest_res[abs(pest_res$logFC)>=1.5 & pest_res$adj.P.Val<=0.05,]) #18

#summarize overlaps
all_probes <- unique(c(grs_res$TargetID, smoke_hits$ID, ht_hits$ID, alc_hits$ID, pest_hits$ID)) #30 unique probes
all_data <- data.frame(TargetID=all_probes, GRS=(all_probes %in% grs_res$TargetID), GRS_smoking=(all_probes %in% smoke_hits$ID), GRS_head_trauma=(all_probes %in% ht_hits$ID), GRS_alcohol=(all_probes %in% alc_hits$ID), GRS_pesticides=(all_probes %in% pest_hits$ID))
sensitivity <- left_join(grs_res[,c("TargetID","UCSC_REFGENE_NAME","UCSC_REFGENE_GROUP","delta_M","adj.P.Val")], all_data[,c(1,3:6)], by="TargetID")
write.csv(sensitivity, file="~/PD_GRS/non_genetic_sensitivity/sensitivity_overlaps.csv", row.names=FALSE)

#upset plot
all_data[,2:6] <- apply(all_data[,2:6], 2, function(x) as.numeric(x))
upset(all_data, sets=c("GRS","GRS_smoking","GRS_head_trauma","GRS_alcohol","GRS_pesticides"),order.by="degree")
```
![Overlap between probes significant in sensitivity analyses and original EWAS](/home1/NEURO/schaffner/PD_GRS/non_genetic_sensitivity/upset.png)

18 probes are consistent across all sensitivity analyses. One additional probe was discovered in the smoking-adjusted analysis, and two additional probes in the alcohol-adjusted analysis. The pesticide-adjusted analysis had four fewer probes than the rest.

## Individual pesticide exposures

EWAS will be conducted 10 times for each exposure (once per imputation), then results will be pooled with the "mice" package. Reference: "prs_pest_mice.Rmd" (Will's original script).
```{r prs ewas pest, eval=F}
# read in individual imputed pesticides data
pest_imp <- read.csv("~/SHARE_DECIPHER/TERRE_pesticides/pesticides_imputed.csv")

# subset to TERRE early disease duration data set
pest_imp <- pest_imp[pest_imp$num %in% meta_sub$patient,]
length(unique(pest_imp$num)) #186 individuals with imputed pesticide data

# summarize pesticides with at least 10% exposed on average over all imputations
# NOTE, for npj PD paper this was required within each sex; here, looking cross-sex
perc_exp <- colSums(pest_imp[3:ncol(pest_imp)],na.rm=TRUE)
perc_exp <- data.frame(pesticide=names(perc_exp),num_exp_10_imp=perc_exp)
perc_exp$avg_exp_10_imp <- perc_exp$num_exp_10_imp/10
perc_exp$perc_exp_10_imp <- (perc_exp$avg_exp_10_imp/186)*100
summary(perc_exp)
#  pesticide         num_exp_10_imp   avg_exp_10_imp   perc_exp_10_imp 
# Length:74          Min.   :  0.00   Min.   : 0.000   Min.   : 0.000  
# Class :character   1st Qu.: 37.75   1st Qu.: 3.775   1st Qu.: 2.030  
# Mode  :character   Median :136.50   Median :13.650   Median : 7.339  
#                    Mean   :207.62   Mean   :20.762   Mean   :11.162  
#                    3rd Qu.:319.75   3rd Qu.:31.975   3rd Qu.:17.191  
#                    Max.   :773.00   Max.   :77.300   Max.   :41.559 
write.csv(perc_exp, file="~/PD_GRS/pest_imp_summary.csv", row.names=F)

nrow(perc_exp <- perc_exp[perc_exp$perc_exp_10_imp>=10,]) # 30 pesticides with >10% exposed
perc_exp$pesticide
# [1] "ins"          "fong"         "herb"         "s"            "cu"           "i_ochl"       "i_oph"       
# [8] "i_carb"       "i_pyr"        "f_carb"       "h_phenol"     "h_phyto"      "h_pico"       "h_triazine"  
#[15] "h_amides"     "h_uree"       "h_quat"       "h_glyphos"    "i_ddt"        "i_lindane"    "f_dithiocarb"
#[22] "f_carb0"      "h_phenolbis"  "h_ureebis"    "tot_carb"     "tot_uree"     "tot_amide"    "tot_triazine"
#[29] "tot_phenol"   "gardening" 

# prepare mice input
pest_imp <- pest_imp[,c("X_imputation_","num",perc_exp$pesticide)]
pest_missing <- read.csv("~/SHARE_DECIPHER/TERRE_pesticides/pesticides.csv")
pest_missing <- pest_missing[pest_missing$num %in% meta_sub$patient,c("num",perc_exp$pesticide)]
all(pest_imp$num[1:186]==pest_missing$num) #TRUE
all(colnames(pest_imp[2:ncol(pest_imp)])==colnames(pest_missing)) #TRUE
mvals_pest <- mvals[,match(pest_missing$num,colnames(mvals))]

pre_mids <-rbind(cbind(data.frame(X_imputation_=0),pest_missing)[,colnames(pest_imp)],pest_imp)
pre_mids <- pre_mids[pre_mids$num %in% colnames(mvals_pest),]
pest_mids <- as.mids(pre_mids, .imp="X_imputation_",.id="num")
terre_pest_meta <- meta_sub[match(rownames(pest_mids$data),meta_sub$patient),]
mvals_pest <- mvals_pest[grs_res$TargetID,rownames(pest_mids$data)]
exposures <- colnames(pest_mids$data)
​
for(exposure in exposures[1]){
  print(paste("EWAS with adjustment for", exposure, sep=" "))
  design_call <- substitute(
    with(pest_mids,
         model.matrix.lm(
           ~ SCORE1_AVG + age + sex + geno_V3 + geno_V4 + geno_V5 + CTP_PC1 + CTP_PC2 + CTP_PC3 + CTP_PC4 + CTP_PC5 + CTP_PC6 + plate + SentrixPosition_A + PD + E,
           data = terre_pest_meta,
           na.action='na.pass')
    ),
    list(E=as.name(exposure)))
  design <- eval(design_call,list(E=as.name(exposure)))
  design <- design$analyses
  res <- parallel::mclapply(
    design,
    function(x){
      na_row <- is.na(rowSums(x))
      eBayes(lmFit(mvals_pest[,!na_row],x[!na_row,]))
    },
    mc.cores = 10)
  coefs <- lapply(res,coef)
  vars <- lapply(res,function(x)(x$stdev.unscaled * sqrt(x$s2.post))^2)
  coefs_per_cpg <- lapply(
    1:nrow(mvals_pest),
    function(i){
      unlist(lapply(coefs,function(mat) mat[i,9]))
    }
  )
  vars_per_cpg <- lapply(
    1:nrow(mvals_pest),
    function(i){
      unlist(lapply(vars,function(mat) mat[i,9]))
    }
  )
  pooled_res <- parallel::mclapply(
    1:nrow(mvals_pest),
    function(i){
      pooled <- pool.scalar(coefs_per_cpg[[i]],vars_per_cpg[[i]],ncol(mvals_pest),k =9)
      out <- data.frame(pooled[-c(2,3)])
      out$P <- 2*pt(abs(out$t),out$df,lower.tail=F)
      return(out)
    },
    mc.cores=20
  )
  names(pooled_res) <- rownames(mvals_pest)
  sum_stats <- rbindlist(pooled_res,idcol="probe")
  fwrite(sum_stats,paste0(exposure,"_pest_imp_sensitivity.txt"),sep="\t",row.names = F,quote=F)
}
```
The pool.scalar function in mice returns a data frame with the following columns: "m", number of imputations; "qbar", pooled estimate; "ubar", mean of pooled within-imputation variances; "b", between-imputation variance; "t", total variance of pooled estimate; "r", relative increase in variance due to nonresponse; "df", degrees of freedom for t reference distribution; "fmi"; fraction of missing information due to nonresponse.

"qbar" ranges from -0.6 and 0.8 (not exactly on same scale as M-value coefficients) - look into its interpretation further...

### Compare results with initial GRS EWAS
```{r compare 2, eval=F}
grs_res <- read.csv("~/PD_GRS/EWAS_TERRE/EWAS_GRS_cross_sex_hits.csv")

ins <- read.delim("~/PD_GRS/ins_pest_imp_sensitivity.txt")
summary(ins$P)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# 0.9876  0.9968  0.9991  0.9968  0.9995  0.9998 

#first, summarize number of hits with adjustment for each pesticide as a sanity check
h_amide <- read.delim("~/PD_GRS/non_genetic_sensitivity/h_amides_pest_imp_sensitivity.txt.gz")
h_amide$adj.P.Val <- p.adjust(h_amide$P, method="BH")
h_amide_hits <- nrow(h_amide[h_amide$adj.P.Val<=0.05,])
rm(h_amide)

h_glyphos <- read.delim("~/PD_GRS/non_genetic_sensitivity/h_glyphos_pest_imp_sensitivity.txt.gz")
h_glyphos$adj.P.Val <- p.adjust(h_glyphos$P, method="BH")
h_glyphos_hits <- nrow(h_glyphos[h_glyphos$adj.P.Val<=0.05,])
rm(h_glyphos)

h_phenol <- read.delim("~/PD_GRS/non_genetic_sensitivity/h_phenol_pest_imp_sensitivity.txt.gz")
h_phenol$adj.P.Val <- p.adjust(h_phenol$P, method="BH")
h_phenol_hits <- nrow(h_phenol[h_phenol$adj.P.Val<=0.05,])
rm(h_phenol)

h_phenolbis <- read.delim("~/PD_GRS/non_genetic_sensitivity/h_phenolbis_pest_imp_sensitivity.txt.gz")
h_phenolbis$adj.P.Val <- p.adjust(h_phenolbis$P, method="BH")
h_phenolbis_hits <- nrow(h_phenolbis[h_phenolbis$adj.P.Val<=0.05,])
rm(h_phenolbis)

h_phyto <- read.delim("~/PD_GRS/non_genetic_sensitivity/h_phyto_pest_imp_sensitivity.txt.gz")
h_phyto$adj.P.Val <- p.adjust(h_phyto$P, method="BH")
h_phyto_hits <- nrow(h_phyto[h_phyto$adj.P.Val<=0.05,])
rm(h_phyto)

h_pico <- read.delim("~/PD_GRS/non_genetic_sensitivity/h_pico_pest_imp_sensitivity.txt.gz")
h_pico$adj.P.Val <- p.adjust(h_pico$P, method="BH")
h_pico_hits <- nrow(h_pico[h_pico$adj.P.Val<=0.05,])
rm(h_pico)

h_quat <- read.delim("~/PD_GRS/non_genetic_sensitivity/h_quat_pest_imp_sensitivity.txt.gz")
h_quat$adj.P.Val <- p.adjust(h_quat$P, method="BH")
h_quat_hits <- nrow(h_quat[h_quat$adj.P.Val<=0.05,])
rm(h_quat)

### all have no hits...
```
